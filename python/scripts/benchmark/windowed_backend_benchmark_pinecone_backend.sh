#!/bin/bash

# Script to run windowed backend-only benchmark experiment with noisy queries using Pinecone backend
# This script uses the noisy queries generated by generate_noisy_queries.py
# and runs the windowed_backend_benchmark_pinecone_backend.py experiment (without QVCache)

set -e

# Change to project root
cd "$(dirname "$0")/../../.." || exit 1

# Define variables
DATASET="deep1m"
DATA_TYPE="float"
DATA_PATH="data/$DATASET/${DATASET}_base.bin"

# Noisy query parameters
N_SPLIT=10
N_SPLIT_REPEAT=30
NOISE_RATIO=0.01

# Window parameters
WINDOW_SIZE=4
N_REPEAT=3
STRIDE=1
N_ROUND=1

# Construct query and groundtruth paths based on noisy query parameters
# Format noise_ratio to match Python script (remove trailing zeros)
NOISE_STR=$(echo "$NOISE_RATIO" | sed 's/\.0*$//;s/\.$//')
QUERY_PATH="data/$DATASET/${DATASET}_query_nsplit-${N_SPLIT}_nrepeat-${N_SPLIT_REPEAT}_noise-${NOISE_STR}.bin"
GROUNDTRUTH_PATH="data/$DATASET/${DATASET}_groundtruth_nsplit-${N_SPLIT}_nrepeat-${N_SPLIT_REPEAT}_noise-${NOISE_STR}.bin"

# Pinecone backend parameters
K=10
SEARCH_THREADS=24
INDEX_NAME="vectors"
API_KEY="${PINECONE_API_KEY:-}"  # Use environment variable if set
# Your Pinecone region/environment (e.g., "us-east-1", "us-west-2", "eu-west-1")
# Check your Pinecone dashboard for the correct region
ENVIRONMENT="${PINECONE_ENVIRONMENT:-us-east-1}"  # Default: us-east-1
METRIC="l2" # Distance metric: "l2", "cosine", or "inner_product"

# Validate window parameters
MIN_SPLIT_REPEAT=$(( (WINDOW_SIZE / STRIDE) * N_REPEAT * N_ROUND ))
if [ "$N_SPLIT_REPEAT" -lt "$MIN_SPLIT_REPEAT" ]; then
    echo "Error: n_split_repeat ($N_SPLIT_REPEAT) must be >= (window_size / stride) * n_repeat * n_round = $MIN_SPLIT_REPEAT"
    exit 1
fi

# Check if query file exists
if [ ! -f "$QUERY_PATH" ]; then
    echo "Error: Query file not found: $QUERY_PATH"
    echo "Please run generate_noisy_queries.sh first to generate the query file."
    exit 1
fi

# Check if groundtruth file exists
if [ ! -f "$GROUNDTRUTH_PATH" ]; then
    echo "Error: Groundtruth file not found: $GROUNDTRUTH_PATH"
    echo "Please run generate_noisy_queries.sh first to generate the groundtruth file."
    exit 1
fi

# Activate virtual environment if it exists
if [ -d "venv" ]; then
    source venv/bin/activate
fi

# Add python directory to PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:$(pwd)/python"

echo "=========================================="
echo "Windowed Backend Benchmark (Pinecone) - Noisy Queries"
echo "=========================================="
echo "Dataset: $DATASET"
echo "Query file: $QUERY_PATH"
echo "Groundtruth file: $GROUNDTRUTH_PATH"
echo "Noise parameters: n_split=$N_SPLIT, n_repeat=$N_SPLIT_REPEAT, noise_ratio=$NOISE_RATIO"
echo "Window parameters: window_size=$WINDOW_SIZE, n_repeat=$N_REPEAT, stride=$STRIDE, n_round=$N_ROUND"
echo "Pinecone index: $INDEX_NAME"
echo "=========================================="
echo ""

# Build command with optional API key and environment
CMD="python3 python/benchmarks/windowed_backend_benchmark_pinecone_backend.py \
  --data_path \"$DATA_PATH\" \
  --query_path \"$QUERY_PATH\" \
  --groundtruth_path \"$GROUNDTRUTH_PATH\" \
  --index_name \"$INDEX_NAME\" \
  --K \"$K\" \
  --search_threads \"$SEARCH_THREADS\" \
  --n_splits \"$N_SPLIT\" \
  --n_split_repeat \"$N_SPLIT_REPEAT\" \
  --data_type \"$DATA_TYPE\" \
  --metric \"$METRIC\" \
  --window_size \"$WINDOW_SIZE\" \
  --n_repeat \"$N_REPEAT\" \
  --stride \"$STRIDE\" \
  --n_round \"$N_ROUND\""

if [ -n "$API_KEY" ]; then
    CMD="$CMD --api_key \"$API_KEY\""
fi

# Always pass environment (required for cloud Pinecone)
CMD="$CMD --environment \"$ENVIRONMENT\""

# Run the benchmark with all parameters and measure memory usage
# Monitor memory using /proc/<pid>/status VmHWM (High Water Mark)

# Start benchmark in background
eval $CMD &

BENCHMARK_PID=$!

# Monitor VmHWM (High Water Mark - peak RSS) while process is running
MAX_RSS=0
while kill -0 "$BENCHMARK_PID" 2>/dev/null; do
    if [ -f "/proc/$BENCHMARK_PID/status" ]; then
        # VmHWM is the peak RSS maintained by kernel
        current_rss=$(grep "^VmHWM:" "/proc/$BENCHMARK_PID/status" 2>/dev/null | awk '{print $2}')
        if [ -n "$current_rss" ] && [ "$current_rss" -gt "$MAX_RSS" ]; then
            MAX_RSS=$current_rss
        fi
    fi
    sleep 0.01
done

# Wait for benchmark to complete and get exit code
wait $BENCHMARK_PID
BENCHMARK_EXIT_CODE=$?

# Get final VmHWM (read quickly before /proc entry is cleaned up)
if [ -f "/proc/$BENCHMARK_PID/status" ]; then
    final_rss=$(grep "^VmHWM:" "/proc/$BENCHMARK_PID/status" 2>/dev/null | awk '{print $2}')
    if [ -n "$final_rss" ] && [ "$final_rss" -gt "$MAX_RSS" ]; then
        MAX_RSS=$final_rss
    fi
fi

if [ $BENCHMARK_EXIT_CODE -ne 0 ]; then
    exit $BENCHMARK_EXIT_CODE
fi

# Display memory statistics
echo ""
echo "=========================================="
echo "Memory Usage Statistics"
echo "=========================================="
if [ -n "$MAX_RSS" ] && [ "$MAX_RSS" -gt 0 ]; then
    MAX_RSS_MB=$((MAX_RSS / 1024))
    echo "Maximum resident set size (RSS): ${MAX_RSS} KB (${MAX_RSS_MB} MB)"
else
    echo "Warning: Could not determine maximum memory usage"
fi

